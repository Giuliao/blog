<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>模块二：编写Go程序 | Giuliao</title><meta name=keywords content="geektime-cn"><meta name=description content="笔记 1. 线程加锁 sync.Mutex：Lock()加锁，Unlock()解锁 sync.RWMutex：不限制读，只限制并发写和并发读写 sync.WaitGroup：等待一组 goroutine 返回 sync.Once：保证某段代码只执行一次 sync.Cond：让一组 goroutine 在满足特定条件时被唤醒 2. 线程调度 进程和线程间共享 Memory Manage、fs、files、signal 调用线程不需要切换上下文，但仍然涉及系统调用 用户态线程解决了系统调用问题，Go 语言基于 GMP 实现用户态线程 3. Go 语言内存管理 4. 包引用与依赖管理，Makefile 项目编译 go mod replace 用法，使用原始 import 路径，替换源为私有地址
makefile
root: export ROOT=github.com/cncamp/golang; .PHONY: root release: echo &#34;building httpserver binary&#34; mkdir -p bin/amd64 CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o bin/amd64 . .PHONY: release 5. 动手编写一个 HTTP Server Go httpserver 底层实现（参考） 6. Go 语言调试 go 专属调试工具 dlv"><meta name=author content><link rel=canonical href=https://giuliao.github.io/blog/posts/geektime-cn/2-writing-go/><link crossorigin=anonymous href=/blog/assets/css/stylesheet.bc9f0190a2b5c2a4cb1b23d39cd08b8a3598fd1de47605dbad74b13d35f36d36.css integrity="sha256-vJ8BkKK1wqTLGyPTnNCLijWY/R3kdgXbrXSxPTXzbTY=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/blog/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://giuliao.github.io/blog/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://giuliao.github.io/blog/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://giuliao.github.io/blog/favicon-32x32.png><link rel=apple-touch-icon href=https://giuliao.github.io/blog/apple-touch-icon.png><link rel=mask-icon href=https://giuliao.github.io/blog/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="模块二：编写Go程序"><meta property="og:description" content="笔记 1. 线程加锁 sync.Mutex：Lock()加锁，Unlock()解锁 sync.RWMutex：不限制读，只限制并发写和并发读写 sync.WaitGroup：等待一组 goroutine 返回 sync.Once：保证某段代码只执行一次 sync.Cond：让一组 goroutine 在满足特定条件时被唤醒 2. 线程调度 进程和线程间共享 Memory Manage、fs、files、signal 调用线程不需要切换上下文，但仍然涉及系统调用 用户态线程解决了系统调用问题，Go 语言基于 GMP 实现用户态线程 3. Go 语言内存管理 4. 包引用与依赖管理，Makefile 项目编译 go mod replace 用法，使用原始 import 路径，替换源为私有地址
makefile
root: export ROOT=github.com/cncamp/golang; .PHONY: root release: echo &#34;building httpserver binary&#34; mkdir -p bin/amd64 CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o bin/amd64 . .PHONY: release 5. 动手编写一个 HTTP Server Go httpserver 底层实现（参考） 6. Go 语言调试 go 专属调试工具 dlv"><meta property="og:type" content="article"><meta property="og:url" content="https://giuliao.github.io/blog/posts/geektime-cn/2-writing-go/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-24T22:58:56+08:00"><meta property="article:modified_time" content="2022-09-24T22:58:56+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="模块二：编写Go程序"><meta name=twitter:description content="笔记 1. 线程加锁 sync.Mutex：Lock()加锁，Unlock()解锁 sync.RWMutex：不限制读，只限制并发写和并发读写 sync.WaitGroup：等待一组 goroutine 返回 sync.Once：保证某段代码只执行一次 sync.Cond：让一组 goroutine 在满足特定条件时被唤醒 2. 线程调度 进程和线程间共享 Memory Manage、fs、files、signal 调用线程不需要切换上下文，但仍然涉及系统调用 用户态线程解决了系统调用问题，Go 语言基于 GMP 实现用户态线程 3. Go 语言内存管理 4. 包引用与依赖管理，Makefile 项目编译 go mod replace 用法，使用原始 import 路径，替换源为私有地址
makefile
root: export ROOT=github.com/cncamp/golang; .PHONY: root release: echo &#34;building httpserver binary&#34; mkdir -p bin/amd64 CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o bin/amd64 . .PHONY: release 5. 动手编写一个 HTTP Server Go httpserver 底层实现（参考） 6. Go 语言调试 go 专属调试工具 dlv"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://giuliao.github.io/blog/posts/"},{"@type":"ListItem","position":2,"name":"模块二：编写Go程序","item":"https://giuliao.github.io/blog/posts/geektime-cn/2-writing-go/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"模块二：编写Go程序","name":"模块二：编写Go程序","description":"笔记 1. 线程加锁 sync.Mutex：Lock()加锁，Unlock()解锁 sync.RWMutex：不限制读，只限制并发写和并发读写 sync.WaitGroup：等待一组 goroutine 返回 sync.Once：保证某段代码只执行一次 sync.Cond：让一组 goroutine 在满足特定条件时被唤醒 2. 线程调度 进程和线程间共享 Memory Manage、fs、files、signal 调用线程不需要切换上下文，但仍然涉及系统调用 用户态线程解决了系统调用问题，Go 语言基于 GMP 实现用户态线程 3. Go 语言内存管理 4. 包引用与依赖管理，Makefile 项目编译 go mod replace 用法，使用原始 import 路径，替换源为私有地址\nmakefile\nroot: export ROOT=github.com/cncamp/golang; .PHONY: root release: echo \u0026#34;building httpserver binary\u0026#34; mkdir -p bin/amd64 CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o bin/amd64 . .PHONY: release 5. 动手编写一个 HTTP Server Go httpserver 底层实现（参考） 6. Go 语言调试 go 专属调试工具 dlv","keywords":["geektime-cn"],"articleBody":"笔记 1. 线程加锁 sync.Mutex：Lock()加锁，Unlock()解锁 sync.RWMutex：不限制读，只限制并发写和并发读写 sync.WaitGroup：等待一组 goroutine 返回 sync.Once：保证某段代码只执行一次 sync.Cond：让一组 goroutine 在满足特定条件时被唤醒 2. 线程调度 进程和线程间共享 Memory Manage、fs、files、signal 调用线程不需要切换上下文，但仍然涉及系统调用 用户态线程解决了系统调用问题，Go 语言基于 GMP 实现用户态线程 3. Go 语言内存管理 4. 包引用与依赖管理，Makefile 项目编译 go mod replace 用法，使用原始 import 路径，替换源为私有地址\nmakefile\nroot: export ROOT=github.com/cncamp/golang; .PHONY: root release: echo \"building httpserver binary\" mkdir -p bin/amd64 CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o bin/amd64 . .PHONY: release 5. 动手编写一个 HTTP Server Go httpserver 底层实现（参考） 6. Go 语言调试 go 专属调试工具 dlv\nglog 日志工具\n性能分析工具\npprof 中 top 各个字段的含义（参考）： flat：函数在 CPU 上运行的时间 flat%：函数在CPU上运行时间的百分比 sum%：是从上到当前行所有函数累加使用 CPU 的比例 cum：这个函数以及子函数运行所占用的时间，应该大于等于flat cum%：这个函数以及子函数运行所占用的比例，应该大于等于flat% linux top 指标中的含义（参考）\n7. kubernetes 中如何使用 Go 语言 课后练习 2.1 将练习 1.2 中的生产者消费者模型修改为多个生产者和多个消费者模式 que := make(chan int, 10) ticker := time.NewTicker(time.Second) ctx, cancel := context.WithCancel(context.Background()) wg := sync.WaitGroup{} producerNum := 10 customerNum := 10 wg.Add(producerNum + customerNum) // producer for i := 0; i \u003c producerNum; i++ { go func(n int) { for { select { case \u003c-ticker.C: que \u003c- n case \u003c-ctx.Done(): wg.Done() fmt.Printf(\"producer %d exit\\n\", n) return } } }(i) } // consumer for i := 0; i \u003c customerNum; i++ { go func(n int) { for { select { case v := \u003c-que: fmt.Printf(\"consume data %d\\n\", v) case \u003c-ctx.Done(): wg.Done() fmt.Printf(\"consumer %d exit\\n\", n) return } } }(i) } time.Sleep(20 * time.Second) cancel() wg.Wait() 课后练习 2.2 接收客户端 request，并将 request 中带的 header 写入 response header 读取当前系统的环境变量中的 VERSION 配置，并写入 response header Server 端记录访问日志包括客户端 IP，HTTP 返回码，输出到 server 端的标准输出 当访问 localhost/healthz 时，应返回 200 // 参考：https://gist.github.com/Boerworz/b683e46ae0761056a636 type loggingResponseWriter struct { http.ResponseWriter statusCode int } func NewLoggingResponseWriter(w http.ResponseWriter) *loggingResponseWriter { // WriteHeader(int) is not called if our response implicitly returns 200 OK, so // we default to that status code. return \u0026loggingResponseWriter{w, http.StatusOK} } func (lrw *loggingResponseWriter) WriteHeader(code int) { lrw.statusCode = code lrw.ResponseWriter.WriteHeader(code) } // getIP returns the ip address from the http request // 参考：https://gist.github.com/miguelmota/7b765edff00dc676215d6174f3f30216 func getIP(r *http.Request) (string, error) { ips := r.Header.Get(\"X-Forwarded-For\") splitIps := strings.Split(ips, \",\") if len(splitIps) \u003e 0 { // get last IP in list since ELB prepends other user defined IPs, meaning the last one is the actual client IP. netIP := net.ParseIP(splitIps[len(splitIps)-1]) if netIP != nil { return netIP.String(), nil } } ip, _, err := net.SplitHostPort(r.RemoteAddr) if err != nil { return \"\", err } netIP := net.ParseIP(ip) if netIP != nil { ip := netIP.String() if ip == \"::1\" { return \"127.0.0.1\", nil } return ip, nil } return \"\", errors.New(\"IP not found\") } // 每个请求都要记录日志需要使用拦截器 func interceptor(handler http.HandlerFunc) http.HandlerFunc { return func(w http.ResponseWriter, r *http.Request) { // 2. 读取当前系统的环境变量中的 VERSION 配置，并写入 response header w.Header().Add(\"version\", os.Getenv(\"VERSION\")) lrw := NewLoggingResponseWriter(w) handler(lrw, r) // 3.Server 端记录访问日志包括客户端 IP，HTTP 返回码，输出到 server 端的标准输出 addr, err := getIP(r) if err != nil { glog.Errorf(\"get addr error %v\\n\", err) } glog.Infof(\"response status code %d, ip addr %s\\n\", lrw.statusCode, addr) } } func main() { flag.Parse() http.HandleFunc(\"/\", interceptor(func(w http.ResponseWriter, r *http.Request) { for k, v := range r.Header { // 1. 接收客户端 request，并将 request 中带的 header 写入 response header w.Header().Add(k, strings.Join(v, \", \")) } })) http.HandleFunc(\"/healthz\", interceptor(func(w http.ResponseWriter, r *http.Request) { // 4. 当访问 localhost/healthz 时，应返回 200 w.WriteHeader(http.StatusOK) })) http.ListenAndServe(\":3000\", nil) } makefile\nrun: go run main.go -logtostderr true .PHONY: run 执行代码\nmake run ","wordCount":"510","inLanguage":"en","datePublished":"2022-09-24T22:58:56+08:00","dateModified":"2022-09-24T22:58:56+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://giuliao.github.io/blog/posts/geektime-cn/2-writing-go/"},"publisher":{"@type":"Organization","name":"Giuliao","logo":{"@type":"ImageObject","url":"https://giuliao.github.io/blog/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://giuliao.github.io/blog/ accesskey=h title="Giuliao (Alt + H)">Giuliao</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://giuliao.github.io/blog/archives title=归档><span>归档</span></a></li><li><a href=https://giuliao.github.io/blog/search/ title=搜索><span>搜索</span></a></li><li><a href=https://giuliao.github.io/blog/tags/ title=标签><span>标签</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://giuliao.github.io/blog/>Home</a>&nbsp;»&nbsp;<a href=https://giuliao.github.io/blog/posts/>Posts</a></div><h1 class=post-title>模块二：编写Go程序</h1><div class=post-meta><span title='2022-09-24 22:58:56 +0800 +0800'>September 24, 2022</span>&nbsp;·&nbsp;3 min</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e7%ac%94%e8%ae%b0 aria-label=笔记>笔记</a><ul><li><a href=#1-%e7%ba%bf%e7%a8%8b%e5%8a%a0%e9%94%81 aria-label="1. 线程加锁">1. 线程加锁</a></li><li><a href=#2-%e7%ba%bf%e7%a8%8b%e8%b0%83%e5%ba%a6 aria-label="2. 线程调度">2. 线程调度</a></li><li><a href=#3-go-%e8%af%ad%e8%a8%80%e5%86%85%e5%ad%98%e7%ae%a1%e7%90%86 aria-label="3. Go 语言内存管理">3. Go 语言内存管理</a></li><li><a href=#4-%e5%8c%85%e5%bc%95%e7%94%a8%e4%b8%8e%e4%be%9d%e8%b5%96%e7%ae%a1%e7%90%86makefile-%e9%a1%b9%e7%9b%ae%e7%bc%96%e8%af%91 aria-label="4. 包引用与依赖管理，Makefile 项目编译">4. 包引用与依赖管理，Makefile 项目编译</a></li><li><a href=#5-%e5%8a%a8%e6%89%8b%e7%bc%96%e5%86%99%e4%b8%80%e4%b8%aa-http-server aria-label="5. 动手编写一个 HTTP Server">5. 动手编写一个 HTTP Server</a></li><li><a href=#6-go-%e8%af%ad%e8%a8%80%e8%b0%83%e8%af%95 aria-label="6. Go 语言调试">6. Go 语言调试</a></li><li><a href=#7-kubernetes-%e4%b8%ad%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8-go-%e8%af%ad%e8%a8%80 aria-label="7. kubernetes 中如何使用 Go 语言">7. kubernetes 中如何使用 Go 语言</a></li></ul></li><li><a href=#%e8%af%be%e5%90%8e%e7%bb%83%e4%b9%a0-21 aria-label="课后练习 2.1">课后练习 2.1</a></li><li><a href=#%e8%af%be%e5%90%8e%e7%bb%83%e4%b9%a0-22 aria-label="课后练习 2.2">课后练习 2.2</a></li></ul></div></details></div><div class=post-content><h2 id=笔记>笔记<a hidden class=anchor aria-hidden=true href=#笔记>#</a></h2><h3 id=1-线程加锁>1. 线程加锁<a hidden class=anchor aria-hidden=true href=#1-线程加锁>#</a></h3><ul><li>sync.Mutex：Lock()加锁，Unlock()解锁</li><li>sync.RWMutex：不限制读，只限制并发写和并发读写</li><li>sync.WaitGroup：等待一组 goroutine 返回</li><li>sync.Once：保证某段代码只执行一次</li><li>sync.Cond：让一组 goroutine 在满足特定条件时被唤醒</li></ul><h3 id=2-线程调度>2. 线程调度<a hidden class=anchor aria-hidden=true href=#2-线程调度>#</a></h3><ul><li>进程和线程间共享 Memory Manage、fs、files、signal</li><li>调用线程不需要切换上下文，但仍然涉及系统调用</li><li>用户态线程解决了系统调用问题，Go 语言基于 GMP 实现用户态线程</li></ul><h3 id=3-go-语言内存管理>3. Go 语言内存管理<a hidden class=anchor aria-hidden=true href=#3-go-语言内存管理>#</a></h3><h3 id=4-包引用与依赖管理makefile-项目编译>4. 包引用与依赖管理，Makefile 项目编译<a hidden class=anchor aria-hidden=true href=#4-包引用与依赖管理makefile-项目编译>#</a></h3><ul><li><p>go mod replace 用法，使用原始 import 路径，替换源为私有地址</p></li><li><p>makefile</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span>  root:
</span></span><span style=display:flex><span>  export ROOT<span style=color:#f92672>=</span>github.com/cncamp/golang;
</span></span><span style=display:flex><span>  .PHONY: root
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  release:
</span></span><span style=display:flex><span>  echo <span style=color:#e6db74>&#34;building httpserver binary&#34;</span>
</span></span><span style=display:flex><span>  mkdir -p bin/amd64
</span></span><span style=display:flex><span>  CGO_ENABLED<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> GOOS<span style=color:#f92672>=</span>linux GOARCH<span style=color:#f92672>=</span>amd64 go build -o bin/amd64 .
</span></span><span style=display:flex><span>  .PHONY: release
</span></span></code></pre></div></li></ul><h3 id=5-动手编写一个-http-server>5. 动手编写一个 HTTP Server<a hidden class=anchor aria-hidden=true href=#5-动手编写一个-http-server>#</a></h3><ul><li>Go httpserver 底层实现（<a href=https://cncamp.notion.site/http-server-socket-detail-e1f350d63c7c4d9f86ce140949bd90c2>参考</a>）</li></ul><h3 id=6-go-语言调试>6. Go 语言调试<a hidden class=anchor aria-hidden=true href=#6-go-语言调试>#</a></h3><ul><li><p>go 专属调试工具 dlv</p></li><li><p>glog 日志工具</p></li><li><p>性能分析工具</p><ul><li>pprof 中 top 各个字段的含义（<a href=https://zhuanlan.zhihu.com/p/371713134>参考</a>）：<ul><li>flat：函数在 CPU 上运行的时间</li><li>flat%：函数在CPU上运行时间的百分比</li><li>sum%：是从上到当前行所有函数累加使用 CPU 的比例</li><li>cum：这个函数以及子函数运行所占用的时间，应该大于等于flat</li><li>cum%：这个函数以及子函数运行所占用的比例，应该大于等于flat%</li></ul></li></ul></li><li><p>linux top 指标中的含义（<a href=https://www.jianshu.com/p/af584c5a79f2>参考</a>）</p></li></ul><h3 id=7-kubernetes-中如何使用-go-语言>7. kubernetes 中如何使用 Go 语言<a hidden class=anchor aria-hidden=true href=#7-kubernetes-中如何使用-go-语言>#</a></h3><h2 id=课后练习-21>课后练习 2.1<a hidden class=anchor aria-hidden=true href=#课后练习-21>#</a></h2><ul><li>将练习 1.2 中的生产者消费者模型修改为多个生产者和多个消费者模式<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>    <span style=color:#a6e22e>que</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>int</span>, <span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ticker</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>NewTicker</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithCancel</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>())
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>wg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>producerNum</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>customerNum</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>producerNum</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>customerNum</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// producer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>producerNum</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>n</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ticker</span>.<span style=color:#a6e22e>C</span>:
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>que</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>n</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>():
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Done</span>()
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;producer %d exit\n&#34;</span>, <span style=color:#a6e22e>n</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      }(<span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// consumer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>customerNum</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>n</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>que</span>:
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;consume data %d\n&#34;</span>, <span style=color:#a6e22e>v</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>():
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Done</span>()
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;consumer %d exit\n&#34;</span>, <span style=color:#a6e22e>n</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }(<span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>20</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Wait</span>()
</span></span></code></pre></div></li></ul><h2 id=课后练习-22>课后练习 2.2<a hidden class=anchor aria-hidden=true href=#课后练习-22>#</a></h2><ol><li>接收客户端 request，并将 request 中带的 header 写入 response header</li><li>读取当前系统的环境变量中的 VERSION 配置，并写入 response header</li><li>Server 端记录访问日志包括客户端 IP，HTTP 返回码，输出到 server 端的标准输出</li><li>当访问 localhost/healthz 时，应返回 200</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// 参考：https://gist.github.com/Boerworz/b683e46ae0761056a636
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>loggingResponseWriter</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>statusCode</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewLoggingResponseWriter</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>loggingResponseWriter</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// WriteHeader(int) is not called if our response implicitly returns 200 OK, so
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// we default to that status code.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>loggingResponseWriter</span>{<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span>}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>lrw</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>loggingResponseWriter</span>) <span style=color:#a6e22e>WriteHeader</span>(<span style=color:#a6e22e>code</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lrw</span>.<span style=color:#a6e22e>statusCode</span> = <span style=color:#a6e22e>code</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lrw</span>.<span style=color:#a6e22e>ResponseWriter</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#a6e22e>code</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// getIP returns the ip address from the http request
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 参考：https://gist.github.com/miguelmota/7b765edff00dc676215d6174f3f30216
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getIP</span>(<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) (<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ips</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;X-Forwarded-For&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>splitIps</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Split</span>(<span style=color:#a6e22e>ips</span>, <span style=color:#e6db74>&#34;,&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>splitIps</span>) &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// get last IP in list since ELB prepends other user defined IPs, meaning the last one is the actual client IP.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>netIP</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>ParseIP</span>(<span style=color:#a6e22e>splitIps</span>[len(<span style=color:#a6e22e>splitIps</span>)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>netIP</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>netIP</span>.<span style=color:#a6e22e>String</span>(), <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ip</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>SplitHostPort</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>RemoteAddr</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>netIP</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>ParseIP</span>(<span style=color:#a6e22e>ip</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>netIP</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ip</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>netIP</span>.<span style=color:#a6e22e>String</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ip</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;::1&#34;</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;127.0.0.1&#34;</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ip</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;IP not found&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 每个请求都要记录日志需要使用拦截器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>interceptor</span>(<span style=color:#a6e22e>handler</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandlerFunc</span>) <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandlerFunc</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 2. 读取当前系统的环境变量中的 VERSION 配置，并写入 response header
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Header</span>().<span style=color:#a6e22e>Add</span>(<span style=color:#e6db74>&#34;version&#34;</span>, <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;VERSION&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>lrw</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewLoggingResponseWriter</span>(<span style=color:#a6e22e>w</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>handler</span>(<span style=color:#a6e22e>lrw</span>, <span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 3.Server 端记录访问日志包括客户端 IP，HTTP 返回码，输出到 server 端的标准输出
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>addr</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getIP</span>(<span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>glog</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;get addr error %v\n&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>glog</span>.<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;response status code %d, ip addr %s\n&#34;</span>, <span style=color:#a6e22e>lrw</span>.<span style=color:#a6e22e>statusCode</span>, <span style=color:#a6e22e>addr</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Parse</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#a6e22e>interceptor</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Header</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 1. 接收客户端 request，并将 request 中带的 header 写入 response header
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Header</span>().<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>v</span>, <span style=color:#e6db74>&#34;, &#34;</span>))
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	}))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/healthz&#34;</span>, <span style=color:#a6e22e>interceptor</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 4. 当访问 localhost/healthz 时，应返回 200
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span>)
</span></span><span style=display:flex><span>	}))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#e6db74>&#34;:3000&#34;</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>makefile</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>run:
</span></span><span style=display:flex><span>	go run main.go -logtostderr true
</span></span><span style=display:flex><span>.PHONY: run
</span></span></code></pre></div><p>执行代码</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make run
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://giuliao.github.io/blog/tags/geektime-cn/>geektime-cn</a></li></ul><nav class=paginav><a class=prev href=https://giuliao.github.io/blog/posts/geektime-cn/3-docker-tech/><span class=title>« Prev</span><br><span>模块三：Docker核心技术</span></a>
<a class=next href=https://giuliao.github.io/blog/posts/geektime-cn/1-golang-chara/><span class=title>Next »</span><br><span>模块一：Go 语言特性</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://giuliao.github.io/blog/>Giuliao</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>