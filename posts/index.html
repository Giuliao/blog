<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Posts | Giuliao</title><meta name=keywords content><meta name=description content="Posts - Giuliao"><meta name=author content><link rel=canonical href=https://giuliao.github.io/blog/posts/><link crossorigin=anonymous href=/blog/assets/css/stylesheet.bc9f0190a2b5c2a4cb1b23d39cd08b8a3598fd1de47605dbad74b13d35f36d36.css integrity="sha256-vJ8BkKK1wqTLGyPTnNCLijWY/R3kdgXbrXSxPTXzbTY=" rel="preload stylesheet" as=style><link rel=icon href=https://giuliao.github.io/blog/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://giuliao.github.io/blog/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://giuliao.github.io/blog/favicon-32x32.png><link rel=apple-touch-icon href=https://giuliao.github.io/blog/apple-touch-icon.png><link rel=mask-icon href=https://giuliao.github.io/blog/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=https://giuliao.github.io/blog/posts/index.xml><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Posts"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://giuliao.github.io/blog/posts/"><meta name=twitter:card content="summary"><meta name=twitter:title content="Posts"><meta name=twitter:description content><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://giuliao.github.io/blog/posts/"}]}</script></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://giuliao.github.io/blog/ accesskey=h title="Giuliao (Alt + H)">Giuliao</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://giuliao.github.io/blog/archives title=归档><span>归档</span></a></li><li><a href=https://giuliao.github.io/blog/search/ title=搜索><span>搜索</span></a></li><li><a href=https://giuliao.github.io/blog/tags/ title=标签><span>标签</span></a></li></ul></nav></header><main class=main><header class=page-header><div class=breadcrumbs><a href=https://giuliao.github.io/blog/>Home</a></div><h1>Posts</h1></header><article class=post-entry><header class=entry-header><h2>模块十：kubernetes的生产化运维</h2></header><div class=entry-content><p>1.镜像仓库的原理与搭建 2.镜像安全 3.基于kubernetes的DevOps 计划、开发、测试、生产运维 git版本管理，镜像版本管理 通过代码变更触发生产部署更新，gitOps 4.基于Github Action、Jenkins的自动化流水线 docker in docker方案
挂载docker.sock到容器内 使用谷歌的kaniko方案 5.基于声明式API的自动化流水线：Tekton 6.连续交付工具：Argo CD 7.日志收集与分析 日志收集工具Grafana loki 8.构建监控系统 课后练习 本周没有好好实操部署prometheus，只完成过了http server的改造，代码参考孟老师视频内的内容。完整代码链接
为 HTTPServer 添加 0-2 秒的随机延时； func DelayedHello(w http.ResponseWriter, r *http.Request) { glog.V(4).Info("entering root handler") timer := metrics.NewTimer() defer timer.ObserveTotal() user := r.URL.Query().Get("user") delay := randRange(0, 2000) // 0～2s的时延 time.Sleep(time.Duration(delay) * time.Millisecond) if user != "" { io.WriteString(w, fmt.Sprintf("hello [%s]\n", user)) } else { io.WriteString(w, "hello [stranger]\n") } io....</p></div><footer class=entry-footer><span title='2022-12-04 15:15:25 +0800 +0800'>December 4, 2022</span>&nbsp;·&nbsp;1 min</footer><a class=entry-link aria-label="post link to 模块十：kubernetes的生产化运维" href=https://giuliao.github.io/blog/posts/geektime-cn/10-kubernetes%E7%9A%84%E7%94%9F%E4%BA%A7%E5%8C%96%E8%BF%90%E7%BB%B4/></a></article><article class=post-entry><header class=entry-header><h2>模块八：生命周期管理和服务发现</h2></header><div class=entry-content><p>1.深入理解pod的生命周期 2.服务发现 3.Service对象 Service类型:
ClusterIP NodePort LoadBalancer Headless ExternalName Service的拓扑支持
4.kube-proxy组件 iptables相关命令
iptables -L -d nat #查看nat类型的iptables规则 iptables-save -t nat # 查看在本机执行过的iptable命令 iptable切换ipvs的操作
企业外部访问k8s内部服务方案：
创建dns记录指向内部loadbalancer的vip 5.DNS原理和实践 6.Ingress对象 7.案例分享 课后作业 第一部分 作业要求：编写 Kubernetes 部署脚本将 httpserver 部署到 Kubernetes 集群，以下是你可以思考的维度。
完整yaml脚本点击链接 完整http server代码点击链接
1. 优雅启动
主要体现在存活探针，可参见4探活部分
2. 优雅终止
主要分为两部分，容器脚本处理，httpserver代码逻辑处理。
在部署的deployment里面设置preStop lifecycle. 主要为shell脚本循环调用killall 确保进程已被kill。killall比起kill的优势在于，应用被kill返回0未被kill返回1.
lifecycle: preStop: exec: command: [ "/bin/sh","-c","while killall /bin/server; do sleep 1; done" ] 应用的优雅关闭代码如下，具体解释请参考注释：
func gracefullyExit(server *http.Server) { ctx, cancel := context....</p></div><footer class=entry-footer><span title='2022-11-20 15:15:25 +0800 +0800'>November 20, 2022</span>&nbsp;·&nbsp;3 min</footer><a class=entry-link aria-label="post link to 模块八：生命周期管理和服务发现" href=https://giuliao.github.io/blog/posts/geektime-cn/8-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AE%A1%E7%90%86%E5%92%8C%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0/></a></article><article class=post-entry><header class=entry-header><h2>模块三：Docker核心技术</h2></header><div class=entry-content><p>1.从系统架构谈起 微服务改造 除了遵循分离微服务的方法建议，也要从公司的人力成本，维护团队管辖的功能范围进行考虑拆分
微服务间通讯 点对点通讯 使用api网关统一管理访问（包含身份认证、鉴权能力） 2.理解Docker 3.Docker核心技术 4.容器网络 5.Dockerfile的最佳实践 多段构建
docker常用指令
from as … run add：从源地址复制到目的地址，add会做解压缩操作 copy：从源地址 课后练习 3.1 Memory 子系统练习
在 cgroup memory 子系统目录中创建目录结构
cd /sys/fs/cgroup/memory mkdir memorydemo cd memorydemo 运行 malloc（在 linux 机器 make build）
查看内存使用情况
watch 'ps -aux|grep malloc|grep -v grep‘ 通过 cgroup 限制 memory
把进程添加到 cgroup 进程配置组 echo ps -ef|grep malloc |grep -v grep|awk ‘{print $2}’ > cgroup.procs 设置 memory.limit_in_bytes echo 104960000 > memory.limit_in_bytes 等待进程被 oom kill...</p></div><footer class=entry-footer><span title='2022-10-04 11:15:25 +0800 +0800'>October 4, 2022</span>&nbsp;·&nbsp;2 min</footer><a class=entry-link aria-label="post link to 模块三：Docker核心技术" href=https://giuliao.github.io/blog/posts/geektime-cn/3-docker-tech/></a></article><article class=post-entry><header class=entry-header><h2>模块二：编写Go程序</h2></header><div class=entry-content><p>笔记 1. 线程加锁 sync.Mutex：Lock()加锁，Unlock()解锁 sync.RWMutex：不限制读，只限制并发写和并发读写 sync.WaitGroup：等待一组 goroutine 返回 sync.Once：保证某段代码只执行一次 sync.Cond：让一组 goroutine 在满足特定条件时被唤醒 2. 线程调度 进程和线程间共享 Memory Manage、fs、files、signal 调用线程不需要切换上下文，但仍然涉及系统调用 用户态线程解决了系统调用问题，Go 语言基于 GMP 实现用户态线程 3. Go 语言内存管理 4. 包引用与依赖管理，Makefile 项目编译 go mod replace 用法，使用原始 import 路径，替换源为私有地址
makefile
root: export ROOT=github.com/cncamp/golang; .PHONY: root release: echo "building httpserver binary" mkdir -p bin/amd64 CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o bin/amd64 . .PHONY: release 5. 动手编写一个 HTTP Server Go httpserver 底层实现（参考） 6. Go 语言调试 go 专属调试工具 dlv...</p></div><footer class=entry-footer><span title='2022-09-24 22:58:56 +0800 +0800'>September 24, 2022</span>&nbsp;·&nbsp;3 min</footer><a class=entry-link aria-label="post link to 模块二：编写Go程序" href=https://giuliao.github.io/blog/posts/geektime-cn/2-writing-go/></a></article><article class=post-entry><header class=entry-header><h2>模块一：Go 语言特性</h2></header><div class=entry-content><p>作业 课后练习 1.1 编写一个小程序： 给定一个字符串数组 [“I”,“am”,“stupid”,“and”,“weak”] 用 for 循环遍历该数组并修改为 [“I”,“am”,“smart”,“and”,“strong”]
func main() { initArr := []string{"I", "am", "stupid", "and", "weak"} for i, v := range initArr { if v == "stupid" { initArr[i] = "smart" } if v == "weak" { initArr[i] = "strong" } } fmt.Println(strings.Join(initArr, " ")) } 课后练习 1.2 基于 Channel 编写一个简单的单线程生产者消费者模型：
队列：队列长度 10，队列元素类型为 int 生产者：每 1 秒往队列中放入一个类型为 int 的元素，队列满时生产者可以阻塞 消费者：每一秒从队列中获取一个元素并打印，队列为空时消费者阻塞 func main() { que := make(chan int, 10) ticker := time....</p></div><footer class=entry-footer><span title='2022-09-17 22:58:56 +0800 +0800'>September 17, 2022</span>&nbsp;·&nbsp;1 min</footer><a class=entry-link aria-label="post link to 模块一：Go 语言特性" href=https://giuliao.github.io/blog/posts/geektime-cn/1-golang-chara/></a></article></main><footer class=footer><span>&copy; 2022 <a href=https://giuliao.github.io/blog/>Giuliao</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>